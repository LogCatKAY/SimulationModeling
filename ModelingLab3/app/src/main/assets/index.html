<html>
<head>
	<meta charset="utf-8">
	<title>Колмагоров</title>

	<link rel="stylesheet" type="text/css" href="mystyle2.css">

	<!--<script src="assets/kernel.js"></script>-->
</head>
<body>
	<!--<script src="assets/table.js"></script>-->



	<p><button onclick="resizeTables()">Пересчитать кол-во состояний системы</button></p>
	<p><input id="mNumber" type="number"></p>

	<p><button onclick="run()">Запуск</button></p>
	<!-- <input type="button" onclick="run()" value="run"> -->

	<!--<input type="button" value="Say hello" onClick="showAndroidToast('Hello Android!')" />-->

	<!--<script type="text/javascript">-->
    <!--function showAndroidToast(toast) {-->
        <!--Android.showToast(toast);-->
    <!--}-->
<!--</script>-->

<script type="text/javascript">
var EPS = 1e-5;


function run() {
	let tableData = document.getElementById("tbl-data");

	let matrix = [];

	for (let r = 1, n = tableData.rows.length; r < n; r++) {
		matrix[r - 1] = [];

        for (let c = 1, m = tableData.rows[r].cells.length; c < m; c++) {
            matrix[r - 1][c - 1] = parseInt(tableData.rows[r].cells[c].innerText);

        	if (isNaN(matrix[r - 1][c - 1])) {
        		matrix[r - 1][c - 1] = 0;
        	}
        }
    }

    let koefKolmagorof = getKoefKolmagorof(matrix);
    let koefSLAU = getKoefSLAU(koefKolmagorof);

    let ans = []
	let tableResult = document.getElementById("tbl-result");

    if (gauss(koefSLAU, ans) != 1) {
    	console.log("ERROR GAUSS");

		for (let c = 1, m = tableData.rows[1].cells.length; c < m; c++) {
	       tableResult.rows[1].cells[c].innerText = NaN;
	   	}

    	return;
    }

 	for (let c = 1, m = tableData.rows[1].cells.length; c < m; c++) {
        tableResult.rows[1].cells[c].innerText = ans[c - 1].toFixed(2);
    }

}

function getKoefKolmagorof(matrix) {
    let result = [];
    for (let i = 0, n = matrix.length; i < n; ++i) {
		result[i] = [];

        for (let j = 0, m = matrix[i].length; j < m; ++j) {
            result[i][j] = 0;
        }
    }

    for (let i = 0, n = matrix.length; i < n; ++i) {
        for (let j = 0, m = matrix[i].length; j < m; ++j) {
        	result[i][i] -= matrix[i][j];
        }
    }

    for (let i = 0, n = matrix.length; i < n; ++i) {
        for (let j = 0, m = matrix[i].length; j < m; ++j) {
        	result[j][i] += matrix[i][j];
        }
    }

    return result;
}

function getKoefSLAU(matrix) {
	let addNormEquation = [];
    for (let i = 0, n = matrix[0].length; i < n; ++i) {
    	addNormEquation.push(1);
    }
    matrix.unshift(addNormEquation);

    for (let i = 1, n = matrix[0].length + 1; i < n; ++i) {
    	matrix[i].push(0);
    }
    matrix[0].push(1);

    return matrix;
}

function gauss (a, ans) {
	let n = a.length;
	let m = a[0].length - 1;


	let where = [];
	for (let i = 0; i < m; ++i) where.push(-1);

	for (let col = 0, row = 0; col < m && row < n; ++col) {
		let sel = row;

		for (let i = row; i < n; ++i)
			if (Math.abs(a[i][col]) > Math.abs(a[sel][col]))
				sel = i;

		if (Math.abs(a[sel][col]) < EPS)
			continue;

		for (let i = col; i <= m; ++i) {
			let c = a[sel][i];
			a[sel][i] = a[row][i];
			a[row][i] = c;
		}
		where[col] = row;

		for (let i = 0; i < n; ++i)
			if (i != row) {
				let c = a[i][col] / a[row][col];
				for (let j = col; j <= m; ++j)
					a[i][j] -= a[row][j] * c;
			}
		++row;
	}

	for (let i = 0; i < m; ++i) ans.push(0);

	for (let i = 0; i < m; ++i)
		if (where[i] != -1)
			ans[i] = a[where[i]][m] / a[where[i]][i];
	for (let i = 0; i < n; ++i) {
		let sum = 0;
		for (let j = 0; j < m; ++j)
			sum += ans[j] * a[i][j];
		if (Math.abs(sum - a[i][m]) > EPS)
			return 0;
	}

	for (let i=0; i<m; ++i)
		if (where[i] == -1)
			return Infinity;

	return 1;
}

	function createTableData(numRows, numCells) {
    var title = document.createElement("h2");
    title.id = "title-data";
    title.innerText = "Таблица данных";
    document.body.appendChild(title);

    var table = document.createElement("table");
    table.id = "tbl-data";
    table.width = 200;
    table.border = 1;

    let titleRow = table.insertRow(-1);
    let newCell = titleRow.insertCell(-1);
    newCell.classList.add("head");
    newCell.innerText = "из\\в";



    for (let j = 0; j < numCells; ++j) {
        let newCell = titleRow.insertCell(-1);
        newCell.innerText = "S" + j;
        newCell.classList.add("head");
    }

    for (let i = 0; i < numRows; ++i) {
        let newRow = table.insertRow(-1);
        let newCell = newRow.insertCell(-1);
        newCell.innerText = "S" + i;
        newCell.classList.add("left-hand");

        for (let j = 0; j < numCells; ++j) {
            let newCell = newRow.insertCell(-1);

            newCell.contentEditable = "true";
            newCell.innerText = "";
            newCell.classList.add("data");
        }
    }

    document.body.appendChild(table);
}

function createTableResult(numCells) {
    var title = document.createElement("h2");
    title.innerText = "Таблица результатов";
    title.id = "title-result";
    document.body.appendChild(title);


    var table = document.createElement("table");
    table.id = "tbl-result";
    table.width = 200;
    table.border = 1;

    let titleRow = table.insertRow(-1);
    let newCell = titleRow.insertCell(-1);
    newCell.classList.add("head");

    for (let j = 0; j < numCells; ++j) {
        let newCell = titleRow.insertCell(-1);
        newCell.innerText = "S" + j;
        newCell.classList.add("head");
    }

    let newRow = table.insertRow(-1);
    newCell = newRow.insertCell(-1);
    newCell.classList.add("left-hand");
    newCell.innerText = "T:";

    for (let j = 0; j < numCells; ++j) {
        let newCell = newRow.insertCell(-1);
        newCell.classList.add("data");
    }

    document.body.appendChild(table);
}

numStates = parseInt(4);

createTableData(numStates, numStates);
createTableResult(numStates);

function resizeTables(){
	document.body.removeChild(document.getElementById("tbl-data"));
	document.body.removeChild(document.getElementById("title-data"));
	document.body.removeChild(document.getElementById("tbl-result"));
	document.body.removeChild(document.getElementById("title-result"));
	numStates = parseInt(document.getElementById("mNumber").value);
	createTableData(numStates, numStates);
	createTableResult(numStates);
}


</script>

</body> 
</html>